<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Bandung Choropleth Map</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
		<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
		<link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">

		<style type="text/css">
			body {
				font-family: 'PT Sans', sans-serif;
			}

			#map {
				width: 100%;
				height: 675px;
			}

			.info {
				padding: 6px 8px;
				font: 14px/16px Arial, Helvetica, sans-serif;
				background: white;
				background: rgba(255,255,255,0.8);
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
			}

			.highcharts-container {
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
				background: rgba(255,255,255,0.8);
			}

			.info h4 {
				margin: 0 0 5px;
				color: #777;
			}
		</style>

	</head>
	<body>
		<div id="map"></div>

		<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
		<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		<script src="http://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/highcharts-3d.js"></script>
		<script src="basemap.js"></script>
		<script>
			L.mapbox.accessToken = 'pk.eyJ1IjoidHJ5ZmF0dXIiLCJhIjoiY2lxdDJ5d3R1MDAydmZybmh3a3VtcmFvMiJ9.lL9RoXOtTscOHiSvOCrL-Q';
			var map              = L.mapbox.map('map').setView([-6.896462, 107.609290], 13);
			var info             = L.control();
			var statBox          = L.control({'position':'bottomleft'});
			var geojson;

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + L.mapbox.accessToken, {
				id: 'mapbox.light'
			}).addTo(map);

			info.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
				this.update();
				return this._div;
			};

			// method that we will use to update the control based on feature properties passed
			info.update = function (props) {
				this._div.innerHTML = '<h4>Tingkat Kepadatan Populasi Kota Bandung Tahun 2015</h4>' +  (props ?
					'<b>' + props._kecamatan + '</b><br />' + props._kepadatan + ' jiwa / km<sup>2</sup>' : 'Pilih Kecamatan');
			};

			statBox.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'statistik');
				return this._div;
			}

			statBox.addTo(map);
			info.addTo(map);

			function getColor(d) {
				return d > 35000 ? '#8C2D04' :
					   d > 30000 ? '#CC4C02' :
					   d > 25000 ? '#EC7014' :
					   d > 20000 ? '#FE9929' :
					   d > 15000 ? '#FEC44f' :
					   d > 10000 ? '#FEE391' :
					   d > 5000  ? '#FFF7BC' :
								   '#FFFFE5';
			}

			function style(feature) {
				return {
					fillColor: getColor(feature.properties._kepadatan),
					weight: 1,
					opacity: 1,
					color: 'white',
					dashArray: '3',
					fillOpacity: 0.7
				};
			}

			function highlightFeature(e) {
				var layer = e.target;

				layer.setStyle({
					weight: 5,
					color: '#666',
					dashArray: '',
					fillOpacity: 0.7
				});

				if (!L.Browser.ie && !L.Browser.opera) {
					layer.bringToFront();
				}

				info.update(layer.feature.properties);
			}

			function resetHighlight(e) {
				geojson.resetStyle(e.target);
				info.update();
			}

			function zoomToFeature(e) {
				var kecamatan = e.target.feature.properties._url;

				$.getJSON('data.json', function (result) {
					for (var i = 0 ; i < result.length; i++) {
						if (result[i].url == kecamatan) {
							dataStatistik(result[i]);
						};
					}
				});

				map.fitBounds(e.target.getBounds());
			}

			function dataStatistik(data) {
				$(function () {
					$('.statistik').highcharts({
						chart: {
							type: 'line',
							style: { fontFamily: 'PT Sans'}
						},
						title: {
							text: 'Jumlah Penduduk di Kecamatan ' + data.kecamatan + ' Tahun 2015'
						},
						subtitle: {
							text: 'Sumber: Portal Data Bandung'
						},
						plotOptions: {
							line: {
								dataLabels: {
									enabled: true
								},
								enableMouseTracking: false
							}
						},
						xAxis: {
							categories: ['2009', '2010', '2011', '2012', '2013', '2014', '2015']
						},
						yAxis: {
							min: 0,
							title: {
								text: 'Jumlah Penduduk'
							}
						},
						legend: {
							enabled: false
						},
						series: [{
							name: 'Jumlah Penduduk',
							data: [data.tahun_2009, data.tahun_2010, data.tahun_2011, data.tahun_2012, data.tahun_2013, data.tahun_2014, data.tahun_2015]
						}]
					});
				});
			}

			geojson = L.geoJson(baseMap, {
				style: style,
				onEachFeature: function onEachFeature(feature, layer) {
					layer.on({
						mouseover: highlightFeature,
						mouseout: resetHighlight,
						click: zoomToFeature
					});
				}
			}).addTo(map);

			map.attributionControl.addAttribution('Data Populasi &copy; <a href="http://data.bandung.go.id/">Portal Data Bandung</a>');
			map.attributionControl.addAttribution('<a href="https://github.com/tryfatur" target="_blank">Try Fathur Rachman</a> &copy 2016;');
		</script>
	</body>
</html>
